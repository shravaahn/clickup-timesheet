<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Time Tracking — v8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --muted:#8b94a7; --text:#e8ecf1;
      --accent:#4f8cff; --accent-2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --border:#242a35; --input:#11141a; --good:#22c55e; --bad:#ef4444;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      color:var(--text); background:linear-gradient(180deg,#0f1115,#0b0d12 60%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card{ width:min(1300px,100%); background:var(--panel); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden; }
    header{ padding:18px 22px; display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--border); background:rgba(255,255,255,.02); }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{ width:34px; height:34px; display:grid; place-items:center; border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#7aa8ff); color:white; font-weight:800; }
    .muted{color:var(--muted)}
    .role-badge{ font-size:12px; padding:6px 10px; border:1px solid var(--border);
      border-radius:999px; color:var(--muted); background:rgba(255,255,255,.02); }
    .wrap{padding:22px}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    button{ appearance:none; border:1px solid var(--border); background:#11141a; color:var(--text);
      padding:10px 14px; border-radius:10px; cursor:pointer; }
    button.primary{background:var(--accent); border-color:transparent; color:white; font-weight:600}
    button.success{background:var(--accent-2); border-color:transparent; color:#06240f; font-weight:600}
    button.warn{background:var(--warn); border-color:transparent; color:#1b1404; font-weight:600}
    button.ghost{background:transparent}
    button:disabled{opacity:.6; cursor:not-allowed}
    input, select{ width:100%; background:var(--input); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px 12px; outline:none; }
    input[disabled].locked{ background:rgba(79,140,255,.08); border-color:rgba(79,140,255,.35); color:#bcd2ff; }
    .grid{ overflow:auto; border:1px solid var(--border); border-radius:12px; margin-top:14px; }
    table{border-collapse:separate; border-spacing:0; width:100%;}
    thead th{ position:sticky; top:0; z-index:2; background:#12151c; color:#c8d2e3;
      border-bottom:1px solid var(--border); text-align:left; font-weight:600; padding:12px; white-space:nowrap; }
    th, td{border-bottom:1px solid var(--border); padding:10px; vertical-align:middle; white-space:nowrap}
    tbody tr:nth-child(even){background:rgba(255,255,255,.02)}
    tfoot td{background:#10131a; color:#d7dfef; font-weight:600}
    .proj-cell{min-width:220px; position:sticky; left:0; background:inherit; z-index:3}
    .num{text-align:right}
    .tiny{font-size:12px; color:var(--muted)}
    .pill{ font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:#cbd5e1; background:#0f131a; }
    .linklike{color:#7aa8ff; cursor:pointer; text-decoration:underline}
    .dash{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:12px; margin-top:16px;}
    .kpi{background:#0f131a; border:1px solid var(--border); border-radius:12px; padding:14px;}
    .kpi .label{font-size:12px; color:var(--muted); margin-bottom:6px}
    .kpi .value{font-size:22px; font-weight:700}
    .kpi.delta.positive .value{color:var(--good)}
    .kpi.delta.negative .value{color:var(--bad)}
    .chartbox{margin-top:12px; background:#0f131a; border:1px solid var(--border); border-radius:12px; padding:12px; overflow:auto;}
    canvas{width:100%; height:220px}
    .pickerRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .label{font-size:12px; color:var(--muted)}
    .togglegrp{display:flex; gap:6px; align-items:center}
    .cellBox{display:grid; grid-template-columns:1fr 1fr; gap:6px}

    /* MODAL */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center;
      z-index:10;
    }
    .modal{
      width:min(520px, 92vw); background:#0f131a; border:1px solid var(--border); border-radius:14px; padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
    }
    .modal header{ display:flex; align-items:center; justify-content:space-between; padding:0 0 10px 0; border:0; }
    .modal h3{ margin:0; font-size:18px }
    .modal .row{ display:grid; gap:8px; margin:12px 0 }
    .modal .row.two{ grid-template-columns:1fr 1fr; }
    .modal footer{ display:flex; gap:10px; justify-content:flex-end; margin-top:8px }
    .help{ font-size:12px; color:var(--muted) }
    .badge{ display:inline-flex; font-size:11px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:#cbd5e1 }
  </style>
</head>
<body>

<!-- LOGIN VIEW -->
<div id="loginView" class="login" hidden>
  <div class="brand" style="margin-bottom:14px">
    <div class="logo">TT</div>
    <div>
      <div style="font-weight:700">Weekly Time Tracking</div>
      <div class="muted">Demo login</div>
    </div>
  </div>
  <h2>Sign in</h2>
  <div class="tiny">Use demo accounts below or create a local one.</div>
  <div style="display:grid; gap:10px; margin-top:12px">
    <label>Username <input id="username" placeholder="e.g., consultant" /></label>
    <label>Password <input id="password" type="password" placeholder="••••••" /></label>
    <label>Role
      <select id="role">
        <option value="consultant">Consultant</option>
        <option value="admin">Admin</option>
      </select>
    </label>
    <a href="/api/auth/clickup-login" id="loginBtn" class="primary" style="display:block; text-align:center;">
  Login with ClickUp
</a>

  </div>
  <div class="tiny" style="margin-top:8px">Demo: consultant/demo · admin/admin</div>
</div>

<!-- APP VIEW -->
<div id="app" class="card" hidden>
  <header>
    <div class="brand">
      <div class="logo">TT</div>
      <div>
        <div style="font-weight:800">Time Tracking</div>
        <div class="muted" id="weekLabel"></div>
      </div>
    </div>
    <div class="controls">
      <span id="userBadge" class="role-badge"></span>
      <span id="viewingBadge" class="role-badge" style="display:none"></span>
      <button id="prevWeek" class="ghost">◀ Prev</button>
      <button id="thisWeek" class="ghost" title="Jump to current week">This Week</button>
      <button id="nextWeek" class="ghost">Next ▶</button>
      <button id="addRow" class="">+ Add Project</button>
      <button id="saveAll" class="success">Save</button>
      <button id="exportCsv" class="">Export CSV</button>
      <button id="logout" class="warn">Log out</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Admin selectors -->
    <div id="adminPickerRow" class="pickerRow" style="display:none">
      <span class="label">Month:</span>
      <select id="monthPicker" style="min-width:180px"></select>
      <span class="label">Week:</span>
      <select id="weekPicker" style="min-width:260px"></select>
      <span class="label">Consultant:</span>
      <select id="consultantPicker" style="min-width:220px"></select>
      <span class="tiny" id="consultantCount"></span>
      <span class="right"></span>
      <div class="togglegrp">
        <span class="label">View:</span>
        <button id="viewWeek" class="primary">Week</button>
        <button id="viewMonth" class="ghost">Month</button>
      </div>
    </div>

    <div class="sumbar">
      <span class="pill" id="sumEst">Est: 0.00h</span>
      <span class="pill" id="sumTracked">Tracked: 0.00h</span>
      <span class="pill" id="sumDelta">Δ (Tracked–Est): 0.00h</span>
      <span class="right tiny" id="periodLabel">Period: Week</span>
    </div>

    <div class="grid">
      <table id="timesheet">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
        <tfoot id="tfoot"></tfoot>
      </table>
    </div>

    <!-- Admin dashboard (unchanged visuals) -->
    <div id="adminTools" style="margin-top:12px; display:none">
      <div class="muted" style="margin-bottom:8px">Admin tools:</div>
      <div class="dash">
        <div class="kpi"><div class="label" id="kpiEstLabel">Total Est Hours (Week)</div><div class="value" id="kpiEst">0.00h</div></div>
        <div class="kpi"><div class="label" id="kpiTrackedLabel">Total Tracked Hours (Week)</div><div class="value" id="kpiTracked">0.00h</div></div>
        <div class="kpi delta" id="kpiDeltaBox"><div class="label" id="kpiDeltaTitle">Δ Tracked – Est</div><div class="value" id="kpiDelta">0.00h</div></div>
      </div>
      <div class="chartbox">
        <div class="title" id="dailyChartTitle">Daily Totals (Est vs Tracked) — Week</div>
        <canvas id="barChart" width="1200" height="220"></canvas>
      </div>
      <div class="chartbox">
        <div class="title">Consultants (Est vs Tracked) — Selected Period</div>
        <canvas id="consultantChart" width="1200" height="260"></canvas>
      </div>
      <div style="margin-top:10px">
        <button id="unlockAll" class="">Unlock all estimates (visible period)</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: time entry details -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <header>
      <h3 id="modalTitle">Time Entry</h3>
      <span class="badge" id="modalContext">—</span>
    </header>

    <div class="row">
      <label>Type
        <select id="timeType">
          <option value="">— Select —</option>
          <option>billable | Meeting</option>
          <option>billable | Builds</option>
          <option>billable | Client Correspondence</option>
          <option>PTO</option>
          <option>Holiday</option>
          <option>Non BIllable | Internal Team Meeting</option>
          <option>Non BIllable | Internal Projects</option>
          <option>Non BIllable | L&amp;D</option>
          <option>Non BIllable | PreSales/Sales</option>
          <option>Non BIllable | Client Research</option>
          <option>Non BIllable | Partner Engagement</option>
        </select>
      </label>
    </div>

    <div class="row" id="subTypeRow" style="display:none">
      <label>Sub Type
        <select id="subType">
          <option value="">— Select —</option>
          <option>Firm Initiative</option>
          <option>Internal Delivery project</option>
          <option>Recruitment</option>
          <option>Special Projects</option>
          <option>Events</option>
        </select>
      </label>
    </div>

    <div class="row two">
      <label>Hours
        <input id="modalHours" type="number" min="0" step="0.25" placeholder="e.g., 1.5" />
      </label>
      <div>
        <div class="help">Only Hours will show in the table. All fields are saved for reporting.</div>
      </div>
    </div>

    <footer>
      <button id="modalCancel" class="ghost">Cancel</button>
      <button id="modalSave" class="primary">Save</button>
    </footer>
  </div>
</div>

<script>
/** ========== Utilities & State ========== **/
const $ = s => document.querySelector(s);
const fmt = n => (isNaN(n)? '0.00' : Number(n).toFixed(2));
const today = new Date();
function startOfWeek(d){ const date = new Date(d); const day = (date.getDay()+6)%7; date.setDate(date.getDate()-day); date.setHours(0,0,0,0); return date; }
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
function ymd(d){ return d.toISOString().slice(0,10); }
function niceDate(d){ return d.toLocaleDateString(undefined,{month:'short',day:'numeric'}); }
function keyFor(u, weekStart){ return `tt.v1::${u.username}::${u.role}::${ymd(weekStart)}`; }
const days = ['Mon','Tue','Wed','Thu','Fri'];

const demoUsers = [
  {username:'consultant', password:'demo', role:'consultant'},
  {username:'admin', password:'admin', role:'admin'}
];
let user = null;
let adminViewUser = null;
let weekStart = startOfWeek(today);
let data = { rows: [] };
let viewMode = 'week';

/** Modal state pointer to the exact cell being edited */
let modalCtx = null; // { wkMon: Date, row, dayIdx, c }

/** Active identity */
function getActiveIdentity(){ if (user?.role==='admin' && adminViewUser) return adminViewUser; return user; }

/** ========== Month helpers (from v7) ========== **/
function weeksInMonth(year, monthIndex){
  const res = [];
  const firstOfMonth = new Date(year, monthIndex, 1);
  let m = startOfWeek(firstOfMonth);
  while (m.getMonth() <= monthIndex){
    if (m.getMonth() === monthIndex) res.push(new Date(m));
    m = addDays(m,7);
    if (m.getMonth() > monthIndex && m.getDate() > 7) break;
  }
  return res;
}
function labelWeekRange(monday){ const fri = addDays(monday,4); return `${niceDate(monday)} — ${niceDate(fri)}`; }
function buildMonthOptions(current){ const out=[]; const base=new Date(current); base.setDate(1); for(let i=-5;i<=6;i++){ out.push(new Date(base.getFullYear(), base.getMonth()+i, 1)); } return out; }

/** ========== Persistence ========== **/
function load(){
  const active = getActiveIdentity();
  const raw = localStorage.getItem(keyFor(active, weekStart));
  data = raw ? JSON.parse(raw) : { rows: [] };
  render();
}
function save(){ localStorage.setItem(keyFor(getActiveIdentity(), weekStart), JSON.stringify(data)); updateAllSummaries(); alert('Saved ✅'); }
function saveSilent(){ localStorage.setItem(keyFor(getActiveIdentity(), weekStart), JSON.stringify(data)); }

/** ========== Login / Routing ========== **/
function showLogin(){ $('#loginView').hidden=false; $('#app').hidden=true; $('#username').value=''; $('#password').value=''; $('#role').value='consultant'; }
function showApp(){
  $('#loginView').hidden=true; $('#app').hidden=false;
  $('#userBadge').textContent = `${user.username} — ${user.role.toUpperCase()}`;
  $('#adminTools').style.display = user.role==='admin' ? 'block' : 'none';
  $('#adminPickerRow').style.display = user.role==='admin' ? 'flex' : 'none';
  $('#viewingBadge').style.display='none';
  viewMode='week';
  if (user.role==='admin'){ populateMonthWeekSelectors(); populateConsultantPicker(); setViewButtons(); }
  buildHead(); load();
}
function verify(u,p,r){ const found = demoUsers.find(x=>x.username===u && x.password===p && x.role===r); if(found) return {username:u, role:r}; if(u&&p) return {username:u, role:r}; return null; }

/** ========== Admin pickers ========== **/
function listConsultantsFromStorage(){
  const set = new Set();
  for (let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i); if (!k || !k.startsWith('tt.v1::')) continue;
    const parts = k.split('::'); if (parts.length!==4) continue;
    const uname=parts[1], role=parts[2]; if (role==='consultant') set.add(uname);
  }
  return Array.from(set).sort();
}
function populateConsultantPicker(){
  const picker = $('#consultantPicker');
  const all = listConsultantsFromStorage();
  picker.innerHTML=''; const ph = document.createElement('option'); ph.value=''; ph.textContent='— Select consultant —'; picker.appendChild(ph);
  all.forEach(u=>{ const opt=document.createElement('option'); opt.value=u; opt.textContent=u; picker.appendChild(opt); });
  $('#consultantCount').textContent = all.length ? `${all.length} found` : 'No consultants found yet';
  picker.onchange = ()=>{ const val=picker.value; adminViewUser = val? {username:val, role:'consultant'} : null;
    $('#viewingBadge').style.display = adminViewUser ? 'inline-flex' : 'none';
    $('#viewingBadge').textContent = adminViewUser ? `Viewing: ${adminViewUser.username}` : '';
    buildHead(); load();
  };
  if (!adminViewUser && all.length){ picker.value = all[0]; adminViewUser = {username:all[0], role:'consultant'}; $('#viewingBadge').style.display='inline-flex'; $('#viewingBadge').textContent=`Viewing: ${adminViewUser.username}`; }
}
function populateMonthWeekSelectors(){
  const monthSel=$('#monthPicker'), weekSel=$('#weekPicker');
  const months = buildMonthOptions(weekStart); monthSel.innerHTML='';
  months.forEach(d=>{ const opt=document.createElement('option'); opt.value = `${d.getFullYear()}-${d.getMonth()}`; opt.textContent = d.toLocaleDateString(undefined,{month:'long',year:'numeric'}); if(d.getFullYear()===weekStart.getFullYear() && d.getMonth()===weekStart.getMonth()) opt.selected=true; monthSel.appendChild(opt); });
  const refreshWeeks=()=>{
    const [yStr,mStr] = monthSel.value.split('-'); const y=Number(yStr), m=Number(mStr);
    const mondays=weeksInMonth(y,m); weekSel.innerHTML='';
    mondays.forEach((mon,idx)=>{ const opt=document.createElement('option'); opt.value=ymd(mon); opt.textContent=`Week ${idx+1}: ${labelWeekRange(mon)}`; if(ymd(mon)===ymd(weekStart)) opt.selected=true; weekSel.appendChild(opt); });
    if (!Array.from(weekSel.options).some(o=>o.value===ymd(weekStart)) && weekSel.options.length){ weekSel.selectedIndex=0; weekStart = startOfWeek(new Date(weekSel.value)); buildHead(); load(); }
  };
  monthSel.onchange = ()=>{ refreshWeeks(); if(viewMode==='month'){ buildHead(); render(); } };
  weekSel.onchange  = ()=>{ weekStart = startOfWeek(new Date(weekSel.value)); buildHead(); load(); };
  refreshWeeks();
}
function syncMonthWeekSelectorsToWeek(){
  if (user?.role!=='admin') return;
  const monthSel=$('#monthPicker'), weekSel=$('#weekPicker'); if(!monthSel||!weekSel||!monthSel.options.length) return;
  const key = `${weekStart.getFullYear()}-${weekStart.getMonth()}`; if (monthSel.value!==key){ populateMonthWeekSelectors(); return; }
  for (let i=0;i<weekSel.options.length;i++){ if (weekSel.options[i].value===ymd(weekStart)){ weekSel.selectedIndex=i; break; } }
}

/** ========== View buttons ========== **/
function setViewButtons(){
  $('#viewWeek').className = viewMode==='week' ? 'primary' : 'ghost';
  $('#viewMonth').className= viewMode==='month'? 'primary' : 'ghost';
  $('#periodLabel').textContent = `Period: ${viewMode==='week' ? 'Week' : 'Month'}`;
  $('#kpiEstLabel').textContent = `Total Est Hours (${viewMode==='week'?'Week':'Month'})`;
  $('#kpiTrackedLabel').textContent = `Total Tracked Hours (${viewMode==='week'?'Week':'Month'})`;
  $('#dailyChartTitle').textContent = `${viewMode==='week'?'Daily':'Weekly'} Totals (Est vs Tracked) — ${viewMode==='week'?'Week':'Month'}`;
}

/** ========== Table Rendering (Week / Month-as-weeks) ========== **/
function buildHead(){
  const thead = $('#thead'); thead.innerHTML='';
  const tr1 = document.createElement('tr');
  const baseTh = document.createElement('th'); baseTh.textContent='Project'; baseTh.className='proj-cell';
  tr1.appendChild(baseTh);

  if (viewMode==='week'){
    const wk=[]; for(let i=0;i<5;i++){ const d=addDays(weekStart,i); wk.push(d);
      const th=document.createElement('th'); th.innerHTML = `<div>${['Mon','Tue','Wed','Thu','Fri'][i]} • ${niceDate(d)}</div><div class="tiny">Est | Tracked</div>`; tr1.appendChild(th); }
    const thT=document.createElement('th'); thT.innerHTML='<div>Total (Week)</div><div class="tiny">Est | Tracked</div>'; tr1.appendChild(thT);
    $('#weekLabel').textContent = `${niceDate(wk[0])} — ${niceDate(wk[4])}`;
  }else{
    const y=weekStart.getFullYear(), m=weekStart.getMonth(); const mondays=weeksInMonth(y,m);
    mondays.forEach((mon,idx)=>{ const th=document.createElement('th'); th.innerHTML = `<div>Week ${idx+1}</div><div class="tiny">${labelWeekRange(mon)}</div>`; tr1.appendChild(th); });
    const thT=document.createElement('th'); thT.innerHTML='<div>Total (Month)</div><div class="tiny">Est | Tracked</div>'; tr1.appendChild(thT);
    if (mondays.length){ const start=new Date(y,m,1), end=new Date(y,m+1,0);
      $('#weekLabel').textContent = `${start.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})} — ${end.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}`;
    }
  }
  thead.appendChild(tr1);
  syncMonthWeekSelectorsToWeek();
}

function render(){
  const tbody=$('#tbody'); tbody.innerHTML='';
  if (viewMode==='week'){
    if (!data.rows.length) addRow();
    data.rows.forEach(row=>{
      const tr=document.createElement('tr');
      const tdProj=document.createElement('td'); tdProj.className='proj-cell';
      const projInput=document.createElement('input'); projInput.placeholder='Project name'; projInput.value=row.project||'';
      projInput.addEventListener('input', e=>{ row.project=e.target.value; saveSilent(); });
      tdProj.appendChild(projInput); tr.appendChild(tdProj);

      let rowEstTotal=0, rowTrkTotal=0;
      for(let d=0; d<5; d++){
        const td=document.createElement('td'); const c=row.cells[d] || {est:'',tracked:'',estLocked:false, trackedMeta:null}; row.cells[d]=c;
        const box=document.createElement('div'); box.className='cellBox';

        // Estimate (same as before)
        const est=document.createElement('input'); est.type='number'; est.step='0.25'; est.min='0'; est.placeholder='Est'; est.className='num'; est.value=c.est??'';
        if (c.est !== '' && c.estLocked){ est.disabled=true; est.classList.add('locked'); est.title='Estimate locked'; }
        est.addEventListener('change', e=>{
          const val=e.target.value===''? '' : Math.max(0, Number(e.target.value));
          c.est=val; if (val!==''){ c.estLocked=true; est.disabled=true; est.classList.add('locked'); est.title='Estimate locked'; }
          saveSilent(); updateAllSummaries();
        });

        // Tracked -> open modal
        const tracked=document.createElement('input'); tracked.type='number'; tracked.step='0.25'; tracked.min='0'; tracked.placeholder='Tracked'; tracked.className='num'; tracked.value=c.tracked??'';
        tracked.readOnly=true; // force modal usage
        tracked.addEventListener('click', ()=> openTimeModal({wkMon:new Date(weekStart), row, dayIdx:d, c}));

        rowEstTotal += Number(c.est||0); rowTrkTotal += Number(c.tracked||0);
        box.append(est, tracked); td.appendChild(box);

        if (c.estLocked && user.role==='admin'){
          const tiny=document.createElement('div'); tiny.className='tiny';
          const link=document.createElement('span'); link.className='linklike'; link.textContent='Unlock est';
          link.addEventListener('click', ()=>{ c.estLocked=false; est.disabled=false; est.classList.remove('locked'); est.title=''; saveSilent(); updateAllSummaries(); });
          tiny.appendChild(link); td.appendChild(tiny);
        }

        // Show a subtle meta badge if type set
        if (c.trackedMeta?.type){
          const tag=document.createElement('div'); tag.className='tiny'; tag.textContent=`${c.trackedMeta.type}${c.trackedMeta.subType? ' • '+c.trackedMeta.subType:''}`;
          td.appendChild(tag);
        }

        tr.appendChild(td);
      }
      const tdTotal=document.createElement('td');
      const tot=document.createElement('div'); tot.className='cellBox';
      const estTot=document.createElement('input'); estTot.className='num locked'; estTot.disabled=true; estTot.value=fmt(rowEstTotal);
      const trkTot=document.createElement('input'); trkTot.className='num'; trkTot.disabled=true; trkTot.value=fmt(rowTrkTotal);
      tot.append(estTot, trkTot); tdTotal.appendChild(tot); tr.appendChild(tdTotal);
      tbody.appendChild(tr);
    });
    buildFooterTotalsWeek();
  }else{
    renderMonthlyWeeksTable();
  }
  updateAllSummaries();
}

/** Month view (columns = weeks) with modal on Tracked inputs */
function renderMonthlyWeeksTable(){
  const tbody=$('#tbody'); tbody.innerHTML=''; const tfoot=$('#tfoot'); tfoot.innerHTML='';
  const who=getActiveIdentity(); const y=weekStart.getFullYear(), m=weekStart.getMonth(); const mondays=weeksInMonth(y,m);

  // union of projects over month
  const projectSet=new Set();
  mondays.forEach(mon=>{ const obj=JSON.parse(localStorage.getItem(keyFor(who, mon))||'{"rows":[]}'); (obj.rows||[]).forEach(r=>projectSet.add((r.project||'').trim())); });
  if (projectSet.size===0) projectSet.add('');
  const projects=Array.from(projectSet);

  projects.forEach(projectName=>{
    const tr=document.createElement('tr');
    const tdProj=document.createElement('td'); tdProj.className='proj-cell';
    const projInput=document.createElement('input'); projInput.placeholder='Project name'; projInput.value=projectName||'';
    projInput.addEventListener('blur', ()=>{
      const newName=projInput.value.trim(); if (newName===projectName) return;
      mondays.forEach(mon=>{ const k=keyFor(who, mon); const obj=JSON.parse(localStorage.getItem(k)||'{"rows":[]}'); const row=(obj.rows||[]).find(r=>(r.project||'')===projectName); if(row){ row.project=newName; localStorage.setItem(k, JSON.stringify(obj)); } });
      render();
    });
    tdProj.appendChild(projInput); tr.appendChild(tdProj);

    let monthlyEst=0, monthlyTrk=0;

    mondays.forEach((mon)=>{
      const key=keyFor(who, mon);
      const obj=JSON.parse(localStorage.getItem(key)||'{"rows":[]}');
      let row=(obj.rows||[]).find(r=>(r.project||'')===projectName);
      if(!row){ row={project:projectName, cells:{}}; obj.rows.push(row); localStorage.setItem(key, JSON.stringify(obj)); }

      const td=document.createElement('td'); const wrap=document.createElement('div'); wrap.style.display='grid'; wrap.style.gap='6px';
      const head=document.createElement('div'); head.className='tiny'; head.textContent=labelWeekRange(new Date(mon));
      wrap.appendChild(head);

      let wkEst=0, wkTrk=0;
      const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(5,1fr)'; grid.style.gap='6px';

      for(let d=0; d<5; d++){
        const c=row.cells[d] || {est:'',tracked:'',estLocked:false, trackedMeta:null}; row.cells[d]=c;

        const cell=document.createElement('div'); cell.className='cellBox';
        const est=document.createElement('input'); est.type='number'; est.step='0.25'; est.min='0'; est.placeholder='Est'; est.className='num'; est.value=c.est??'';
        if (c.est !== '' && c.estLocked){ est.disabled=true; est.classList.add('locked'); est.title='Estimate locked'; }
        est.addEventListener('change', e=>{
          const val=e.target.value===''? '' : Math.max(0, Number(e.target.value));
          c.est=val; if (val!==''){ c.estLocked=true; est.disabled=true; est.classList.add('locked'); est.title='Estimate locked'; }
          localStorage.setItem(key, JSON.stringify(obj)); updateAllSummaries();
        });

        const tracked=document.createElement('input'); tracked.type='number'; tracked.step='0.25'; tracked.min='0'; tracked.placeholder='Tracked'; tracked.className='num'; tracked.value=c.tracked??'';
        tracked.readOnly=true;
        tracked.addEventListener('click', ()=> openTimeModal({wkMon:new Date(mon), row, dayIdx:d, c}));

        wkEst += Number(c.est||0); wkTrk += Number(c.tracked||0);
        cell.append(est, tracked);
        grid.appendChild(cell);
      }

      wrap.appendChild(grid);
      // tiny badge if the last edited day has meta (optional visual)
      if (Object.values(row.cells).some(cc=>cc?.trackedMeta?.type)){
        const tag=document.createElement('div'); tag.className='tiny'; tag.textContent='Has categorized entries';
        wrap.appendChild(tag);
      }

      td.appendChild(wrap); tr.appendChild(td);
      monthlyEst += wkEst; monthlyTrk += wkTrk;
      localStorage.setItem(key, JSON.stringify(obj));
    });

    const tdTotal=document.createElement('td'); const tot=document.createElement('div'); tot.className='cellBox';
    const estTot=document.createElement('input'); estTot.className='num locked'; estTot.disabled=true; estTot.value=fmt(monthlyEst);
    const trkTot=document.createElement('input'); trkTot.className='num'; trkTot.disabled=true; trkTot.value=fmt(monthlyTrk);
    tot.append(estTot, trkTot); tdTotal.appendChild(tot); tr.appendChild(tdTotal);

    tbody.appendChild(tr);
  });

  // Footer totals per week + month
  const trf=document.createElement('tr'); const tdLabel=document.createElement('td'); tdLabel.textContent='All Projects Total'; tdLabel.className='proj-cell'; trf.appendChild(tdLabel);
  let grandEst=0, grandTrk=0;
  mondays.forEach(mon=>{
    const obj=JSON.parse(localStorage.getItem(keyFor(who, mon))||'{"rows":[]}'); let we=0, wt=0;
    (obj.rows||[]).forEach(row=>{ for(let d=0; d<5; d++){ const c=row.cells?.[d]; if(!c) continue; we+=Number(c.est||0); wt+=Number(c.tracked||0);} });
    grandEst+=we; grandTrk+=wt;
    const td=document.createElement('td'); const box=document.createElement('div'); box.className='cellBox';
    const est=document.createElement('input'); est.className='num locked'; est.disabled=true; est.value=fmt(we);
    const trk=document.createElement('input'); trk.className='num'; trk.disabled=true; trk.value=fmt(wt);
    box.append(est, trk); td.appendChild(box); trf.appendChild(td);
  });
  const tdGrand=document.createElement('td'); const boxG=document.createElement('div'); boxG.className='cellBox';
  const estG=document.createElement('input'); estG.className='num locked'; estG.disabled=true; estG.value=fmt(grandEst);
  const trkG=document.createElement('input'); trkG.className='num'; trkG.disabled=true; trkG.value=fmt(grandTrk);
  boxG.append(estG, trkG); tdGrand.appendChild(boxG); trf.appendChild(tdGrand);
  $('#tfoot').appendChild(trf);
}

/** ========== Totals / Charts (unchanged) ========== **/
function computeTotalsWeek(){
  let est=0,trk=0; const dailyEst=[0,0,0,0,0], dailyTrk=[0,0,0,0,0];
  (data.rows||[]).forEach(row=>{ for(let d=0; d<5; d++){ const c=row.cells?.[d]; if(!c) continue; const e=Number(c.est||0), t=Number(c.tracked||0); est+=e; trk+=t; dailyEst[d]+=e; dailyTrk[d]+=t; }});
  return {est, trk, delta: trk-est, dailyEst, dailyTrk};
}
function computeTotalsMonth(){
  const who=getActiveIdentity(); const y=weekStart.getFullYear(), m=weekStart.getMonth(); const mondays=weeksInMonth(y,m);
  let est=0,trk=0; const weeklyEst=[], weeklyTrk=[], labels=[];
  mondays.forEach((mon,idx)=>{ const obj=JSON.parse(localStorage.getItem(keyFor(who, mon))||'{"rows":[]}'); let we=0,wt=0;
    (obj.rows||[]).forEach(row=>{ for(let d=0; d<5; d++){ const c=row.cells?.[d]; if(!c) continue; we+=Number(c.est||0); wt+=Number(c.tracked||0);} });
    est+=we; trk+=wt; weeklyEst.push(we); weeklyTrk.push(wt); labels.push(`W${idx+1}`); });
  return {est, trk, delta: trk-est, weeklyEst, weeklyTrk, labels};
}
function updateAllSummaries(){
  if (viewMode==='week'){
    const t=computeTotalsWeek(); $('#sumEst').textContent=`Est: ${fmt(t.est)}h`; $('#sumTracked').textContent=`Tracked: ${fmt(t.trk)}h`; $('#sumDelta').textContent=`Δ (Tracked–Est): ${fmt(t.delta)}h`;
  } else {
    const t=computeTotalsMonth(); $('#sumEst').textContent=`Est: ${fmt(t.est)}h`; $('#sumTracked').textContent=`Tracked: ${fmt(t.trk)}h`; $('#sumDelta').textContent=`Δ (Tracked–Est): ${fmt(t.delta)}h`;
  }
}

/** ========== Modal logic ========== **/
function openTimeModal(ctx){
  modalCtx = ctx; // {wkMon,row,dayIdx,c}
  const proj = ctx.row.project || '(Untitled Project)';
  const theDay = ['Mon','Tue','Wed','Thu','Fri'][ctx.dayIdx];
  $('#modalContext').textContent = `${proj} • ${theDay} • ${niceDate(addDays(ctx.wkMon, ctx.dayIdx))}`;

  // preload values
  const meta = ctx.c.trackedMeta || {};
  $('#timeType').value = meta.type || '';
  $('#subType').value  = meta.subType || '';
  $('#modalHours').value = ctx.c.tracked ?? '';

  toggleSubType();

  $('#modalBackdrop').style.display='flex';

  // focus hours first for speedy input
  setTimeout(()=>$('#modalHours').focus(), 10);
}
function closeTimeModal(){ $('#modalBackdrop').style.display='none'; modalCtx=null; }
function toggleSubType(){
  const v = ($('#timeType').value||'').trim();
  const show = v.toLowerCase() === 'non billable | internal projects' || v === 'Non BIllable | Internal Projects';
  $('#subTypeRow').style.display = show ? 'block' : 'none';
  if (!show) $('#subType').value = '';
}

$('#timeType').addEventListener('change', toggleSubType);
$('#modalCancel').addEventListener('click', closeTimeModal);
$('#modalBackdrop').addEventListener('click', (e)=>{ if (e.target.id==='modalBackdrop') closeTimeModal(); });
document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && $('#modalBackdrop').style.display==='flex') closeTimeModal(); });

$('#modalSave').addEventListener('click', ()=>{
  if (!modalCtx) return;
  const hours = $('#modalHours').value === '' ? '' : Math.max(0, Number($('#modalHours').value));
  const type = $('#timeType').value || '';
  const subType = $('#subType').value || '';

  // write to the *correct week file* (works for both views)
  const who = getActiveIdentity();
  const key = keyFor(who, startOfWeek(modalCtx.wkMon));
  const obj = JSON.parse(localStorage.getItem(key) || '{"rows":[]}');
  // find the same row by reference: fallback by project name + shape
  let row = obj.rows.find(r => r === modalCtx.row) || obj.rows.find(r => (r.project||'') === (modalCtx.row.project||''));
  if (!row){ row = {project: modalCtx.row.project||'', cells:{}}; obj.rows.push(row); }
  const d = modalCtx.dayIdx;
  const cell = row.cells[d] || {est:'', tracked:'', estLocked:false, trackedMeta:null};
  cell.tracked = hours;
  cell.trackedMeta = { type, subType };
  row.cells[d] = cell;

  localStorage.setItem(key, JSON.stringify(obj));

  // if we’re currently looking at this same week, also reflect in in-memory data
  if (ymd(startOfWeek(modalCtx.wkMon)) === ymd(weekStart)){
    modalCtx.c.tracked = hours;
    modalCtx.c.trackedMeta = { type, subType };
    saveSilent();
    render(); // redraw badges and totals
  } else {
    // different week (month view), just refresh summaries
    updateAllSummaries();
  }

  closeTimeModal();
});

/** ========== Footer (week) ========== **/
function buildFooterTotalsWeek(){
  const tfoot=$('#tfoot'); tfoot.innerHTML='';
  const { dailyEst, dailyTrk } = computeTotalsWeek();
  const grandEst=dailyEst.reduce((a,b)=>a+b,0), grandTrk=dailyTrk.reduce((a,b)=>a+b,0);
  const tr=document.createElement('tr');
  const tdLabel=document.createElement('td'); tdLabel.textContent='All Projects Total'; tdLabel.className='proj-cell'; tr.appendChild(tdLabel);
  for(let d=0; d<5; d++){
    const td=document.createElement('td'); const box=document.createElement('div'); box.className='cellBox';
    const est=document.createElement('input'); est.className='num locked'; est.disabled=true; est.value=fmt(dailyEst[d]);
    const trk=document.createElement('input'); trk.className='num'; trk.disabled=true; trk.value=fmt(dailyTrk[d]);
    box.append(est, trk); td.appendChild(box); tr.appendChild(td);
  }
  const tdGrand=document.createElement('td'); const boxG=document.createElement('div'); boxG.className='cellBox';
  const estG=document.createElement('input'); estG.className='num locked'; estG.disabled=true; estG.value=fmt(grandEst);
  const trkG=document.createElement('input'); trkG.className='num'; trkG.disabled=true; trkG.value=fmt(grandTrk);
  boxG.append(estG, trkG); tdGrand.appendChild(boxG); tr.appendChild(tdGrand);
  tfoot.appendChild(tr);
}

/** ========== Row helpers ========== **/
function addRow(){ data.rows.push({ project:'', cells:{} }); render(); }

/** ========== Events ========== **/
$('#loginBtn').addEventListener('click', ()=>{
  const u=$('#username').value.trim(); const p=$('#password').value.trim(); const r=$('#role').value;
  const ok=verify(u,p,r); if(!ok){ alert('Invalid credentials for demo.'); return; }
  user=ok; adminViewUser=null; showApp();
});
$('#logout').addEventListener('click', ()=>{ user=null; adminViewUser=null; showLogin(); });

$('#addRow').addEventListener('click', ()=>{
  if (viewMode==='week'){ data.rows.push({ project:'', cells:{} }); render(); }
  else{
    const who=getActiveIdentity(); const obj=JSON.parse(localStorage.getItem(keyFor(who, weekStart))||'{"rows":[]}');
    obj.rows.push({ project:'', cells:{} }); localStorage.setItem(keyFor(who, weekStart), JSON.stringify(obj)); render();
  }
});
$('#saveAll').addEventListener('click', save);
$('#exportCsv').addEventListener('click', ()=>{
  const csv = toCSV();
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  const period = viewMode==='week' ? ymd(weekStart) : `${weekStart.getFullYear()}-${String(weekStart.getMonth()+1).padStart(2,'0')}`;
  a.download=`timesheet_${getActiveIdentity().username}_${period}.csv`; a.click();
});
$('#prevWeek').addEventListener('click', ()=>{ weekStart=addDays(weekStart,-7); buildHead(); load(); });
$('#nextWeek').addEventListener('click', ()=>{ weekStart=addDays(weekStart, +7); buildHead(); load(); });
$('#thisWeek').addEventListener('click', ()=>{ weekStart=startOfWeek(new Date()); buildHead(); load(); });

$('#unlockAll').addEventListener('click', ()=>{
  if (user.role!=='admin') return;
  if (!confirm(`Unlock all estimate fields for visible ${viewMode}?`)) return;
  if (viewMode==='week'){
    (data.rows||[]).forEach(row=>{ for(let d=0; d<5; d++){ if(!row.cells?.[d]) continue; row.cells[d].estLocked=false; }});
    saveSilent(); render();
  }else{
    const who=getActiveIdentity(); const y=weekStart.getFullYear(), m=weekStart.getMonth();
    weeksInMonth(y,m).forEach(mon=>{ const k=keyFor(who, mon); const obj=JSON.parse(localStorage.getItem(k)||'{"rows":[]}');
      (obj.rows||[]).forEach(row=>{ for(let d=0; d<5; d++){ if(!row.cells?.[d]) continue; row.cells[d].estLocked=false; }});
      localStorage.setItem(k, JSON.stringify(obj));
    });
    render();
  }
});

$('#viewWeek').addEventListener('click', ()=>{ if (viewMode!=='week'){ viewMode='week'; setViewButtons(); buildHead(); load(); } });
$('#viewMonth').addEventListener('click', ()=>{ if (viewMode!=='month'){ viewMode='month'; setViewButtons(); buildHead(); render(); } });

/** CSV: same as v7 (no meta yet—reporting API will read from storage) */
function toCSV(){
  if (viewMode==='week'){
    const header=['Project', ...['Mon','Tue','Wed','Thu','Fri'].flatMap(lbl=>[`${lbl} Est`,`${lbl} Tracked`]), 'Total Est (Week)','Total Tracked (Week)'];
    const rows=[header];
    (data.rows||[]).forEach(row=>{
      let rowEst=0,rowTrk=0; const r=[row.project||''];
      for(let d=0; d<5; d++){ const c=row.cells?.[d]||{}; const e=Number(c.est||0), t=Number(c.tracked||0);
        r.push(c.est ?? '', c.tracked ?? ''); rowEst+=e; rowTrk+=t; }
      r.push(fmt(rowEst), fmt(rowTrk)); rows.push(r);
    });
    return rows.map(r=>r.map(cell=>{ const s=String(cell??''); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }).join(',')).join('\n');
  } else {
    const y=weekStart.getFullYear(), m=weekStart.getMonth(), mondays=weeksInMonth(y,m), who=getActiveIdentity();
    const header=['Project', ...mondays.map((_,i)=>`Week ${i+1} Est`), ...mondays.map((_,i)=>`Week ${i+1} Tracked`), 'Total Est (Month)','Total Tracked (Month)'];
    const rows=[header];
    // union of projects
    const projectSet=new Set(); mondays.forEach(mon=>{const obj=JSON.parse(localStorage.getItem(keyFor(who, mon))||'{"rows":[]}'); (obj.rows||[]).forEach(r=>projectSet.add((r.project||'').trim()));});
    const projects=Array.from(projectSet.size?projectSet:new Set(['']));
    projects.forEach(projectName=>{
      const estWeeks=[], trkWeeks=[];
      mondays.forEach(mon=>{
        const obj=JSON.parse(localStorage.getItem(keyFor(who, mon))||'{"rows":[]}');
        const row=(obj.rows||[]).find(r=>(r.project||'')===projectName);
        let we=0,wt=0; for(let d=0; d<5; d++){ const c=row?.cells?.[d]; if(!c) continue; we+=Number(c.est||0); wt+=Number(c.tracked||0); }
        estWeeks.push(fmt(we)); trkWeeks.push(fmt(wt));
      });
      const totalEst=estWeeks.map(Number).reduce((a,b)=>a+b,0), totalTrk=trkWeeks.map(Number).reduce((a,b)=>a+b,0);
      rows.push([projectName||'', ...estWeeks, ...trkWeeks, fmt(totalEst), fmt(totalTrk)]);
    });
    return rows.map(r=>r.map(cell=>{ const s=String(cell??''); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }).join(',')).join('\n');
  }
}

/** Boot */
(function init(){
  const last=sessionStorage.getItem('tt.lastUser');
  if (last){ user=JSON.parse(last); showApp(); } else { showLogin(); }
  window.addEventListener('beforeunload', ()=>{ if (user) sessionStorage.setItem('tt.lastUser', JSON.stringify(user)); else sessionStorage.removeItem('tt.lastUser'); });
})();
</script>
<script>
  async function checkLoginAndLoad() {
    try {
      const sessionRes = await fetch("/api/session");
      const sessionData = await sessionRes.json();
      
      if (!sessionData.loggedIn) {
        document.querySelector("#dashboard-section").style.display = "none";
        document.querySelector("#login-section").style.display = "block";
        return;
      }

      // Hide login, show dashboard
      document.querySelector("#login-section").style.display = "none";
      document.querySelector("#dashboard-section").style.display = "block";

      // Fetch workspaces
      const teamsRes = await fetch("/api/teams");
      const teamsData = await teamsRes.json();
      const teamId = teamsData.teams[0].id; // Pick first team for now

      // Fetch tasks
      const tasksRes = await fetch(`/api/tasks/${teamId}`);
      const tasksData = await tasksRes.json();

      // Populate table
      const tbody = document.querySelector("#tasks-table-body");
      tbody.innerHTML = "";
      tasksData.tasks.forEach(task => {
        const row = document.createElement("tr");
        const projectCell = document.createElement("td");
        projectCell.textContent = task.name;

        const assigneesCell = document.createElement("td");
        assigneesCell.textContent = task.assignees?.map(a => a.username).join(", ") || "No assignees";

        row.appendChild(projectCell);
        row.appendChild(assigneesCell);
        tbody.appendChild(row);
      });
    } catch (err) {
      console.error("Error loading dashboard:", err);
    }
  }

  document.addEventListener("DOMContentLoaded", checkLoginAndLoad);
</script>

</body>
</html>
